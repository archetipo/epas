#{extends 'main.html' /}
#{set title:personMonth.person.surname + ' ' + personMonth.person.name + ', matricola=' + personMonth.person.number /}

<h2 id="titoloSituazionePresenzeMensili">Situazione presenze mensile <span class="capitalized">&{'views.tags.display.date.month.' + personMonth.month}</span> ${personMonth.year}</h2>


#{logoutForm /}

#{functionalMenuForm mainMenu: mainMenu /} 
<input type="hidden" name="personId" value="${personMonth.person.id}"  />
<table id="presenze_mensili">
	<tr>
		<th>Buono mensa</th>
		<th>Giorno</th>
		<th>Codice di assenza</th>
		%{ for(int i = 1; i <= numberOfInOut; i++){
		}%
		<th>${i}° entrata</th>
		<th>${i}° uscita</th>
		%{ } }%
		<th>Tempo lavoro</th>
		<th>Differenza</th>
		<th>Progressivo</th>
		<th>Tipo Orario</th>
	</tr>
	
%{
     for(day in personMonth.days) {
}%
		
<tr>
			%{
			if(day.isHoliday()==false){
			}%	<td>${String.format(messages.get('views.common.yes_or_no.'+ day.mealTicket()))}</td>
			%{
			}else{
			}%	<td>${String.format(messages.get('views.common.yes_or_no.true'))}</td>
			%{
			}
			}%
			%{
			if(day.isHoliday()==false){
			}%	<td class="capitalized">${String.format(messages.get('views.tags.display.date.format.dayAndShortDayName'), day.date.toDate())}</td>
			
			%{
			}else{
			}%	<td class="festivi">${String.format(messages.get('views.tags.display.date.format.dayAndShortDayName'), day.date.toDate())}</td>
			%{
			}
			}%
			<td class="assenza">${day.absenceList().size()>0  ? day.absenceList().get(0).absenceType.code : ''}</td>
			%{  int j = 0;
				for(int i = 0; i < numberOfInOut; i++){
					j = i*2;
				}%
				<td class="ingresso">
				%{ if(day.stampingList().size() > j && day.stampingList().get(j) !=null ) { }%
				<!--  	<a href="@{Stampings.edit(day.getStampings().get(j).id)}" class="insertStamping${day.date.dayOfMonth}"> -->
					${day.stampings.get(j).date.toCalendarTime()}
				<!--  	</a> -->
				${(day.stampingList().get(j).stampModificationType?.code)} 
				${(day.stampingList().get(j).stampType != null ? day.stampingList().get(j).stampType.identifier : '')}
					%{ } }%
				</td>
				
				<td class="uscita">
				%{ if(day.stampingList().size() > j+1 && day.stampingList().get(j+1) !=null ) { }%
				<!--  	<a href="@{Stampings.edit(day.getStampings().get(j+1).id)}" class="insertStamping${day.date.dayOfMonth}"> -->
					${day.stampingList().get(j+1).date.toCalendarTime()}
				<!--  	</a> -->
					${(day.stampingList().get(j+1).stampModificationType?.code)} 
				${(day.stampingList().get(j).stampType != null ? day.stampingList().get(j).stampType.identifier : '')}
					%{ } }%
				</td>
			
				%{ } }%
			
			%{
			if(day.stampingList().size()==2 ){
	         }% <td class="tempoLavoro">${day.isHoliday()==false ? day.timeAtWork.toHourTime() : ''} <strong>${day.timeAtWork>360 ? day.checkTimeForLunch()?.code : ''}</strong></td>
			%{
			 }else{
			 }% <td class="tempoLavoro">${day.isHoliday()==false ? day.timeAtWork.toHourTime() : ''} <strong>${day.stampingList().size()==4 && !day.stampingList().contains(null) && day.timeAtWork>300
			 && day.checkMinTimeForLunch()<30 ? day.checkTimeForLunch()?.code : ''}</strong></td>
			%{
	         }
	         }%	
	         %{
	        if(day.isHoliday()==false){
			}%
	         <td class="differenza">${(day.difference).toHourTime()}</td>
			%{
			}else{
			}%<td class="differenza"></td>
			%{
			}
			}%
	        %{
	        if(day.isHoliday()==false){
			}% <td class="progressivo">${day.progressive.toHourTime()}</td>
			%{
			}else{
			}%<td class="progressivo">${day.checkPreviousProgressive() != null ? day.checkPreviousProgressive().progressive.toHourTime() : ''}</td>
			%{
			}
			}%		
	         <td>${day.person.workingTimeType != null ? day.person.workingTimeType.description : ''}</td>
		</tr>

%{  		   
     }
     
}%

</table>
<p>Il numero di riposi compensativi usati da inizio anno a oggi è: <strong>${numberOfCompensatoryRest}</strong></p>
<p id="spiegazioneTabellaTimbrature">Il numero di buoni mensa usabili per questo mese e': <strong>${personMonth.numberOfMealTicketToUse()}</strong>, mentre quelli da restituire sono <strong>${personMonth.numberOfMealTicketToRender()}</strong>. Il numero di giorni lavorativi in sede è di: <strong>${personMonth.basedWorkingDays()}</strong> </p>

<p>Riepilogo delle ore di lavoro in eccesso/difetto:</p> 
<p> - E' possibile utilizzare il residuo dell'anno precedente? ${personMonth.possibileUtilizzareResiduoAnnoPrecedente()==true ? 'sì' : 'no'}</p>
<p> - Eventuale residuo da inizializzazione: ${personMonth.residuoAnnoPrecedenteDaInizializzazione().toHourTime()}</p>
<p> - Residuo anno precedente disponibile a inizio mese: ${personMonth.residuoAnnoPrecedenteDisponibileAllInizioDelMese().toHourTime()}</p>
<p> - Residuo tempo di lavoro dei mesi precedenti: ${personMonth.totaleResiduoAnnoCorrenteAlMesePrecedente().toHourTime()}</p> 
<p> - Residuo del mese:  ${personMonth.residuoDelMese().toHourTime()}</p>
<p> - Tempo disponibile per straordinari: ${personMonth.tempoDisponibilePerStraordinari().toHourTime()}</p>
<p> - Totale residuo anno corrente a fine mese:  ${personMonth.totaleResiduoAnnoCorrenteAFineMese().toHourTime()}</p>
<p> - Giorni di riposo compensativo: ${personMonth.getCompensatoryRest()} per un totale di: -${(personMonth.getCompensatoryRestInMinutes(personMonth.getCompensatoryRest())).toHourTime()} ore</p>
<p> - Totale residuo a fine mese  <strong>${personMonth.totaleResiduoAnnoCorrenteAFineMesePiuResiduoAnnoPrecedenteDisponibileAFineMese().toHourTime()} ore</strong></p>


*{Significato codici assenza}*
<div>
<h3 align="left">Note:</h3>
<table id="Note timbrature">
	<tr>
		<th width="80">Codice timbratura</th>
		<th width="400">Descrizione</th>
			
	</tr>
%{
     for(smt in personMonth.getStampingCode()) {
}%
	<tr>
		<td>${smt.code}</td>     
		<td>${smt.description}</td>		
	</tr>
	
	
%{  		   
     }
     
}%
%{	if(personMonth.getStampType() != null){
	for(type in personMonth.getStampType()) {
}%
	<tr>
		<td>${type.identifier}</td>
		<td>${type.description}</td>
	</tr>
%{  		   
     }
    }
}%
</table>

<br>
<br>
<h3 align="left">Tabella codici di assenza</h3>
<table id="Codici di assenza">
	<tr>
		<th width="80">Codice assenza</th>
		<th width="200">Descrizione</th>
		<th width="80">Numero giorni</th>
			
	</tr>
%{
     for(entry in personMonth.getAbsenceCode().entrySet()) {
}%
	<tr>
		<td>${entry.getKey().code}</td>     
		<td>${entry.getKey().description}</td>	
		<td>${entry.getValue()}</td>	
	</tr>

%{  		   
     }
     
}%
</table>
</div>