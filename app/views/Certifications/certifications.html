#{extends 'main.html' /}
#{set header:'navbar' /}
#{set title: 'ePAS - Invio Attestati'  /}

#{set 'moreScripts'}
<script type="text/javascript">
    function progress(value){
     var current = $('.progress-bar').attr("aria-valuenow");
     var next = +current + value;
     next= Math.round(next * 100) / 100
     if (next > 99 ){ $('#loading').fadeOut(1000); }
     $('.progress-bar').css('width', next+'%').attr('aria-valuenow', next);
     $('.progress-bar').children('span.sr-only:first').text(next+'%'+' Completato');
    }
</script>
#{/set}
<div class="container">
  #{title title:'ePAS - Supporto per Invio Attestati', administration:true /}
</div>

<div class="container">
  #{alert color:'info'}
  <p>
    Attraverso questa pagina è possibile popolare gli attestati CNR per il mese e sede selezionati
    nella nuova
    piattaforma.
  </p>
  #{/alert}

  #{alert color:'info'}
  <p><strong>Guida</strong></p>
  <p>
    Dopo aver effettuato l'operazione di <em>Stralcio</em> in attestati, cliccare sul
    pulsante <strong>Processa</strong>.
  </p>
  <p>
    La procedura si occuperà di inviare i dati ancora non presenti in attestati e di rimuovere
    quelli obsoleti.
  </p>
  <p><strong>Nota bene</strong><br>
    E' possibile processare i dati più volte, fino a quando
    l'attestato non sarà validato attraverso la funzione <em>Valida Attestati</em> in attestati.<br>
    L'operazione Processa non ha effetti per ogni attestato già validato <i class="fa fa-ban"
                                                                            data-content="Attestato validato su attestati non modificabile."></i>
  </p>
  #{/alert}

  #{if matchNumbers && !matchNumbers.empty} *{ se è injettato è stata ottenuta
  l'autenticazione }*
  #{if !notInEpas.empty}
    #{alert color:'danger'}
    <p>Ci sono matricole attive in attestati non inserite in ePAS.</p>
      #{list notInEpas}
        <span class="label label-danger">${_}</span>
      #{/list}
    #{/alert}
  #{/if}

  #{if !notInAttestati.empty}
    #{alert color:'danger'}
    <p>Ci sono persone attive nel mese in ePAS non in attestati. Controllare le loro matricole.</p>
      #{list notInAttestati}
        <span class="label label-danger">${_}</span>
      #{/list}
    #{/alert}
  #{/if}

  #{b.buttons center:true}
  #{if process}
    #{b.link @certifications(office.id, validYear, validMonth), color:'info', fa:'refresh'}
      <span class="text-default">Aggiorna dati</span>
    #{/b.link}
  #{/if}
  #{else}
    #{b.link @processAll(office.id, validYear, validMonth), color:'warning', fa:'cloud-upload'}
      <span class="text-default">Carica tutti i dati su Attestati</span>
    #{/b.link}
  #{/else}
  #{/b.buttons}
  <br>
  <div id="loading">
    #{if process}
      <h6><em class="text-muted"><i class="fa fa-spin fa-spinner"></i> Invio dati in corso...</em></h6>
    #{/if}
    #{else}
      <h6><em class="text-muted"><i class="fa fa-spin fa-spinner"></i> Caricamento in corso...</em></h6>
    #{/else}
    <div class="progress">
      <div class="progress-bar progress-bar-success progress-bar-striped active" role="progressbar"
           aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" >
        <span class="sr-only">0% Complete</span>
      </div>
    </div>
  </div>


  *{
  MI SERVE UN MODO PER PASSARE IL COMANDO PROCESS AL CONTROLLER CERTIFICATIONS
  SENZA CHE QUESTO VADA NELL'URL, IN MODO CHE SE SI FA REFRESH DELLA PAGINA NON VENGA RIEFFETTUATO
  L'INVIO AD ATTESTATI
  #{secure.check 'Certifications.processAll'}
    <a class="btn btn-warning" href="@{Certifications.processAll(office.id, validYear, validMonth)}">Processa <i class="fa fa-cloud-upload" aria-hidden="true"></i></a>
  #{/secure.check}
 }*
  *{
  <a class="btn btn-danger pull-right"
     href="@{Certifications.emptyCertifications(office.id, validYear, validMonth)}">Svuota Attestati <i class="fa fa-trash-o" aria-hidden="true"></i></a>
  }*

  <ul class="list-group">

    #{list people, as:'person' }
    #{if !matchNumbers.empty && matchNumbers.contains(person.number)}
    #{if process}
    <!-- INVIO INFORMAZIONI AD ATTESTATI-->
      <div data-load-async="@{process(person.id, validYear, validMonth, false)}">
    #{/if}
    #{else}
    <!-- CARICAMENTO INFORMAZIONI DA ATTESTATI -->
      <div data-load-async="@{personStatus(person.id, validYear, validMonth)}">
    #{/else}
      <li class="list-group-item">
        <div class="row">
          <div class="col-xs-3">
            <strong>${person.fullname}</strong>
            <br><em>matricola:</em> ${person.number}
          </div>
          <div class="col-xs-3">
            #{if process}
              <i class="fa fa-spin fa-spinner"></i> Invio dati in corso...
            #{/if}
            #{else}
              <i class="fa fa-spin fa-spinner"></i> Caricamento dati in corso...
            #{/else}
          </div>
        </div>
      </li>
    </div>
    #{/if}
    #{else}
    <li class="list-group-item disabled">
      <div class="row">
        <div class="col-xs-3">
          <strong>${person.fullname}</strong>
          <br><em>matricola:</em> ${person.number}
        </div>
        <div class="col-xs-3">
          <em>Non presente su Attestati</em>
        </div>
      </div>
    </li>
    #{/else}
    #{/list}
  </ul>
  #{/if}

</div>