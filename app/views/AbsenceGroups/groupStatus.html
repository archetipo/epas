#{extends 'main.html' /}
#{set header:'navbar' /}
#{set title: 'ePAS - Assenze'  /}

<div class="container">

#{title title:absenceEngine.person.fullname + ' - Controllo assenze con limiti e completamenti' /}
  
     #{form action:@AbsenceGroups.changeGroupStatus(), method:'POST', autocomplete:false, class:'form form-horizontal auto-submit'}
       #{f.hidden 'person.id', value:absenceEngine.person.id /}
       #{f.date 'date', value:date.format() /}     
       #{f.selectModel 'groupAbsenceType', items:groups, value:groupAbsenceType /}
     #{/form} 
    
    
  <a class="btn btn-primary" href="@{Stampings.personStamping(absenceEngine.person.id, date.year, date.monthOfYear)}">Torna alle timbrature</a>
    
  #{if absenceEngine.report.containsCriticalProblems() }
  #{alert color:'danger'}
    <p>Impossibile visualizzare la situazione. Effettuare una segnalazione.</p>
  #{/alert}
  #{/if}
  
  
  #{list items:absenceEngine.periodChain.periods, as:'absencePeriod' }

    #{alert color:'info'}
      <strong>Gruppo</strong> ${absencePeriod.groupAbsenceType.description}<br>
      <strong>Tipo periodo</strong> &{absencePeriod.groupAbsenceType.periodType} <br>
      <strong>Validità periodo</strong> ${absencePeriod.from.format()} - ${absencePeriod.to.format()}
    #{/alert}


     <table class="table table-condensed table-bordered">
      <tr>
        <th>Data</th>
        <th>Assenza</th>
        <th>Limite<br>Utilizzabile</th>
        <th>Limite<br>Consumato</th>
        <th>Completamento<br>Precedente<br></th>
        <th>Completamento<br>Assenza</th>
        <th>Completamento<br>Residuo<br></th>
      </tr>
      #{list items:absencePeriod.daysStatus.values(), as:'dayStatus'}
      #{list items:dayStatus.buildDayRows(), as:'rowRecap' }
        <tr #{if dayStatus.complationCompromisedInThisDay()} class="bg-danger" #{/if}
            #{elseif dayStatus.complationCompromised()} class="bg-info" #{/elseif}>
          <td>
            #{if rowRecap.date}
              ${rowRecap.date.format()}
              #{if dayStatus.complationCompromisedInThisDay()}
                <i class="fa fa-fire-extinguisher" aria-hidden="true"></i> 
              #{/if}
            #{/if}  
          </td>
          <td>
              #{if !rowRecap.absence.troubles.empty }
		        <i class="fa fa-exclamation-triangle text-danger" webui-popover-hover data-url="#containError${rowRecap.absence.id}"></i>
		      #{/if}
		      <div class="webui-popover-content" id="containError${rowRecap.absence.id}">
                #{list items:rowRecap.absence.troubles, as:'trouble'}
                  <strong>&{trouble.trouble}</strong><br>
                #{/list}
                #{if rowRecap.missingReplacing }
                <p> 
                  Il codice di rimpiazzamento da inserire è
                  <span class="label label-default">${rowRecap.missingReplacing.code}</span>
                  #{form action:@AbsenceGroups.addReplacing(), method:'POST', autocomplete:false, class:'form form-horizontal'}
                    #{f.hidden 'date', value:dayStatus.date.format() /}
                    #{f.hidden 'person.id', value:absenceEngine.person.id /}
                    #{f.hidden 'groupAbsenceType.id', value:absencePeriod.groupAbsenceType.id /}
                    #{f.hidden 'absenceType.id', value:rowRecap.missingReplacing.id /}
                    #{b.buttons center:true}
                      #{b.submit 'Aggiungi'/}
                    #{/b.buttons}
                  #{/form}
	                
                </p>
                #{/if}
              </div>
              #{absences.absence-popover absence:rowRecap.absence, groupSelected:absencePeriod.groupAbsenceType /}
			  	                
          </td>
          <td>${rowRecap.usableLimit}</td>
          <td>${rowRecap.usableTaken}</td>
          <td>${rowRecap.consumedComplationBefore}</td>
          <td>${rowRecap.consumedComplationAbsence}</td>
          <td>${rowRecap.consumedComplationNext}</td>
        </tr>
      #{/list}
      #{/list}
      </table>
      
  #{/list}
    
</div>
