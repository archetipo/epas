#{extends 'main.html' /}
#{set header:'navbar' /}
#{set title: 'ePAS - Assenze'  /}

<div class="container">

#{title title:absenceEngine.person.fullname + ' - ' + absenceEngine.periodChain.chainDescription /}
  
  #{if absenceEngine.report.containsCriticalProblems() }
  #{alert color:'danger'}
    <p>Impossibile visualizzare la situazione. Effettuare una segnalazione.</p>
  #{/alert}
  #{/if}
  
  
  #{list items:absenceEngine.periodChain.periods, as:'absencePeriod' }

    <p>  
      <strong>Periodo validità</strong>
      <br>Data inizio: ${absencePeriod.from.format()}
      <br>Data fine: ${absencePeriod.to.format()}
    </p>  
    <p>
      <strong>Gruppo</strong>
      ${absencePeriod.groupAbsenceType.description}
    </p>
    
    <ul class="list-group">
    #{list items:absencePeriod.daysStatus.values(), as:'dayStatus'}
    
    
    <li class="list-group-item">
    <strong>Giorno ${dayStatus.date.format()}</strong><br>
    
    
    #{list items:dayStatus.takenAbsences, as:'takenAbsence'}
       <p>
          <span class="label label-danger">${takenAbsence.absence.absenceType.code}</span>
          <span class="label label-primary">Tetto residuo</span><span class="label label-default">${templateUtility.printAmount(takenAbsence.residualBeforeTakable, takenAbsence.amountTypeTakable)}</span>
          <span class="label label-primary">Tetto consumato</span><span class="label label-default">${templateUtility.printAmount(takenAbsence.consumedTakable, takenAbsence.amountTypeTakable)}</span>
          #{list items:takenAbsence.absence.troubles, as:'trouble'}
            ${trouble.trouble}
          #{/list}
       </p>
    #{/list}

          <!-- TODO: render complationSameDay e replacingSameDay -->
          
          <!-- TODO: render compromisedComplation -->
          <!-- TODO: render compromisedReplacing -->
    
    #{if dayStatus.complationAbsence}
      <p>
        <span class="label label-success">${dayStatus.complationAbsence.absenceType.code}</span>
        <span class="label label-primary">Da completare</span><span class="label label-default">${templateUtility.printAmount(dayStatus.residualBeforeComplation, dayStatus.amountTypeComplation)}</span>
        <span class="label label-primary">Quantità</span><span class="label label-default">${templateUtility.printAmount(dayStatus.consumedComplation, dayStatus.amountTypeComplation)}</span>
      </p>
      <p>
        #{if dayStatus.correct() && dayStatus.existentReplacing }
          <span class="label label-primary">Codice completamento</span><span class="label label-warning">${dayStatus.existentReplacing.absenceType.code}</span>
        #{/if}
      </p>    
      <p>
        <span class="label label-primary">Al prossimo completamento</span><span class="label label-default">${templateUtility.printAmount(dayStatus.residualAfterComplation, dayStatus.amountTypeComplation)}</span>
      </p>  
    #{/if}
    
    
    </li>
    #{/list}
    </ul>
    
    
    
    
  
    *{
    #{if absencePeriod.isTakable()}
      <p><strong>Riepilogo Limiti</strong></p>
      <table class="table table-condensed">
        <tr>
          <th>Data</th>
          <th>Codice</th>
          <th>Descrizione</th>
          <th>Residuo Precedente</th>
          <th>Ammontare</th>
          <th class="text-muted">Nuovo Residuo</th>
          <th class="text-muted">Scadenza Residuo</th>
        </tr>
      #{list items:absencePeriod.takenAbsencesStatus, as:'absenceStatus'}
         
          <tr>
            <td>${absenceStatus.absence.getAbsenceDate().format()}</td>
            <td>${absenceStatus.absence.absenceType.code}</td>
            <td>${absenceStatus.absence.absenceType.description}</td>
            <td>${templateUtility.printAmount(absenceStatus.residualBeforeTakable, absenceStatus.amountTypeTakable)}</td>
            <td>${templateUtility.printAmount(absenceStatus.consumedTakable, absenceStatus.amountTypeTakable)}</td>
            <td class="text-muted">${templateUtility.printAmount(absenceStatus.residualBeforeTakable - absenceStatus.consumedTakable, absenceStatus.amountTypeTakable)}</td>
            <td class="text-muted">${absencePeriod.to.format()}</td>
          </tr>
      #{/list}
      </table>
    #{/if}

    #{if absencePeriod.isComplation()}
      <p><strong>Riepilogo Completamenti</strong></p>
      <table class="table table-condensed">
        <tr>
          <th>Data</th>
          <th>Esito</th>
          <th>Da Completare</th>
          <th>Ammontare Consumato</th>
          <th class="text-muted">Nuovo Da Completare</th>
        </tr>
      #{list items:absencePeriod.replacingDaysStatus.values(), as:'replacingDay'}
         
          <tr>
            <td>${replacingDay.date.format()}</td>
            <td>
              #{if replacingDay.correct() } OK #{/if}
              #{if replacingDay.wrongType() } Tipo sbagliato #{/if}
              #{if replacingDay.onlyCorrect() } Missing #{/if}
              #{if replacingDay.onlyExisting() } TooEarly #{/if}
            </td>
            <td>${templateUtility.printAmount(replacingDay.residualBeforeComplation, replacingDay.amountTypeComplation)}</td>
            <td>${templateUtility.printAmount(replacingDay.consumedComplation, replacingDay.amountTypeComplation)}</td>
            <td class="text-muted">${templateUtility.printAmount(replacingDay.residualAfterComplation, replacingDay.amountTypeComplation)}</td>
          </tr>
      #{/list}
      </table>
    #{/if}
    }*
  
  #{/list}
    
</div>