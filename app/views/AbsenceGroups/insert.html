#{modalAsync id:'modalAbsence', button:'Salva',
title:'Nuovo codice assenza in data ' + absenceRequestForm.from?.format()
+ ' per ' + absenceRequestForm.person.fullname }

<div id="absenceData">

 #{absences.insertAbsencesTabs absenceRequestForm:absenceRequestForm /}

 *{ alcune scorciatorie }*
 %{ selectedFormItem = absenceRequestForm.selectedAbsenceGroupFormItem; }%
 %{ selecteSubItem = selectedFormItem?.selectedSubAbsenceGroupFormItems; }%
 %{ alldaySelected = selecteSubItem?.selectedJustified?.name.equals(models.absences.JustifiedType.JustifiedTypeName.all_day) ||
                     selecteSubItem?.selectedJustified?.name.equals(models.absences.JustifiedType.JustifiedTypeName.assign_all_day) }%
 %{ specifiedMinuteSelected = selecteSubItem?.selectedJustified?.name.equals(models.absences.JustifiedType.JustifiedTypeName.specified_minutes) }%

 #{if absenceRequestForm.absenceInsertTab.newImplementation() }

   #{include './_selectGroup.html' /}
   #{include './_configureSelectedGroup.html' /}
   #{include './_verifyRequest.html' /}
 
   #{if report.containsProblems()}
    #{alert color:'danger'}
      #{if !report.absencesRemainingTroubles.keySet().empty}
        <strong>La richiesta ha riscontrato la presenza di assenze contenenti errori.</strong>
        #{list items:report.absencesRemainingTroubles.keySet(), as:'absence'}
          <br><strong>${absence.absenceDate.format()}</strong>
          #{absences.absence-popover absence:absence, 
            person:absenceRequestForm.person, 
            groupSelected:selectedFormItem.groupAbsenceType,
            remainingTroubles:report.absencesRemainingTroubles.get(absence) /}
        #{/list}
      #{/if}
      #{if !report.requestProblems.empty}
        <strong>La richiesta effettuata contiene errori.</strong>
        #{list items:report.requestProblems, as:'requestProblem'}
            <br>${requestProblem.date.format()}
            ${requestProblem.requestProblem}
        #{/list}
      #{/if}
      #{if !report.implementationProblems.empty}
        <strong>Errori legati all'implementazione</strong><br>
        #{list items:report.implementationProblems, as:'implementationProblem'}
          <table class="table table-condensed">
          <tr>
            <td>${implementationProblem.date.format()}</td>
            <td>${implementationProblem.implementationProblem}</td>
          </tr>
          </table>
        #{/list}
      #{/if}
      </p>
    #{/alert} 
  #{/if}
  
  #{if !report.insertDaysStatus.empty }
    <table class="table table-condensed table-bordered">
      <tr>
        <th>Data</th>
        <th>Assenza</th>
        <th>Limite<br>Utilizzabile</th>
        <th>Limite<br>Consumato</th>
        <th>Completamento<br>Precedente<br></th>
        <th>Completamento<br>Assenza</th>
        <th>Completamento<br>Residuo<br></th>
      </tr>
      #{list items:report.insertDaysStatus, as:'dayStatus'}
      #{list items:dayStatus.buildDayRows(), as:'rowRecap' }
        <tr>
          <td>
            #{if rowRecap.date}
              ${rowRecap.date.format()}
            #{/if}  
          </td>
          <td>
              #{absences.absence-popover absence:rowRecap.absence, 
              groupSelected:selectedFormItem.groupAbsenceType,
              person:absenceRequestForm.person /}
          </td>
          <td>${rowRecap.usableLimit}</td>
          <td>${rowRecap.usableTaken}</td>
          <td>${rowRecap.consumedComplationBefore}</td>
          <td>${rowRecap.consumedComplationAbsence}</td>
          <td>${rowRecap.consumedComplationNext}</td>
        </tr>
      #{/list}
      #{/list}
      </table>
   #{/if} 
      
     *{ save request }*
	 #{form action:@AbsenceGroups.save(), method:'POST', autocomplete:false, class:'form form-horizontal',
	  'data-async':'#page_content', 'data-async-error':'#absenceData', 'data-spinner':'#defaultSpinner'}
	  
	     #{f.hidden 'personId', value:absenceRequestForm.person.id /}
      
         #{f.hidden 'from', value:absenceRequestForm.from?.format() /}
         #{if alldaySelected }
          #{f.hidden 'to', value:absenceRequestForm.to?.format() /}
         #{/if}
   
      #{f.hidden 'groupAbsenceType.id', value:selectedFormItem.groupAbsenceType.id /}
      #{f.hidden 'absenceType.id', value:selecteSubItem.absenceType?.id /}
      #{f.hidden 'justifiedType.id', value:selecteSubItem.selectedJustified.id /}
      
      #{f.hidden 'hours', value:selecteSubItem.hours /}
         #{f.hidden 'minutes', value:selecteSubItem.minutes /}
    
      #{if report.containsProblems() }
       #{alert color:'info'}
         <p> La richiesta contiene errori e non può essere completata. </p>
         <p> E' comunque possibile forzare l'inserimento <strong>selezionando 
         il codice specifico</strong> e cliccando su Salva. Non verranno effettuati controlli di integrità dei dati inseriti.
         </p>
       #{/alert}
       #{if !selecteSubItem.isAutomatic() }
            #{f.checkbox 'forceInsert', value:forceInsert /}
       #{/if}
	   #{/if}
	 
	   #{b.buttons center:true}
         #{b.submit 'Salva'/}
       #{/b.buttons}
	 #{/form}	  
    
   #{/if}#{else}
   
   *{ old implementations }*
	  
	  #{if forceInsert}
	    #{set action:@Absences.forceInsert() /}
	  #{/if}
	  #{else}
	    #{set action:@Absences.save() /}
	  #{/else}
	
	  #{form action:action, method:'POST', autocomplete:false,
	  class:'form form-horizontal', 'data-async':'#page_content',
	  'data-async-error':'#absenceData', 'data-spinner':'#defaultSpinner'}
	  
      #{f.hidden 'personId', value:absenceRequestForm.person.id /}
	  #{f.hidden 'dateFrom', value:absenceRequestForm.from?.format() /}
      #{f.date 'dateFrom', value:absenceRequestForm.from?.format(), disabled:true /}     
      #{f.date 'dateTo', value:absenceRequestForm.to?.format() /}
      #{f.selectModel 'absenceType', items: templateUtility.getAbsenceTypes(absenceRequestForm.absenceInsertTab), required:true /}
	  
	  *{ #{f.input 'absenceFile', type:'file' /} }*
	
	  #{b.buttons center:true}
	  #{b.submit 'Inserisci'/}
	  #{/b.buttons}
	
	  #{/form}
	
	  #{accordionItem 'nuovaAssenza', parent:'info', title:'Informazioni utili', open:true }
	  <p>Se si vuole inserire un'assenza per più giorni, inserire nel campo <strong>Fino a</strong>
	    il giorno fino al quale si vuole inserire tale codice d'assenza.</p>
	  <p>Di default, in tale campo, viene visualizzato il giorno di partenza per cui si vuole inserire l'assenza</p>
	  <p class="text-info" style="margin-top: 5px;"><em>N.B. Non e' possibile inserire in uno stesso giorno
	    due codici di assenza che giustificano tutto il giorno</em></p>
	  <p>Utilizzando il codice <em>FER</em> il software provvederà ad assegnare ferie e permessi
	    fin quando disponibili nel seguente ordine di priorità:
	  <ul>
	    <li>31 (recupero ferie anno precedente)</li>
	    <li>94 (permesso)</li>
	    <li>32 (ferie anno corrente)</li>
	  </ul>
	  </p>
	  #{/accordionItem}
   
   #{/else}   
  
   
</div>

#{/modalAsync}